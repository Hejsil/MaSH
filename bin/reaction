#!/bin/bash

case $1 in
'get'|'add'|'del'|'del_mod'|'del_all')
	[[ ! -z "$2" ]] && TEXT=$2 || read TEXT
	CHANNEL=$(echo "$TEXT" | jq -r ".channel");
	TEXT=$(echo "$TEXT" | jq "del(.channel)")
	case $1 in
	'get')
		BEFORE=$(echo "$TEXT" | jq -r ".before//empty")
		[ -n $BEFORE ] || BEFORE="before=$BEFORE&"
		AFTER=$(echo "$TEXT" | jq -r ".after//empty")
		[ -n $AFTER ] || AFTER="after=$AFTER&"
		LIMIT=$(echo "$TEXT" | jq -r ".limit//empty")
		[ -n $LIMIT ] || LIMIT="limit=$LIMIT"
		
		[ -n $BEFORE$AFTER$LIMIT ] || Q='?'
		MSG=$(echo "$TEXT" | jq -r ".id"); EMOJI=$(echo "$TEXT" | jq -r ".emoji")
		dapi GET "/channels/$CHANNEL/messages/$MSG/reactions/$EMOJI$Q$BEFORE$AFTER$LIMIT" " " ;;
	'add')
		MSG=$(echo "$TEXT" | jq -r ".id"); EMOJI=$(echo "$TEXT" | jq -r ".emoji")
		dapi PUT "/channels/$CHANNEL/messages/$MSG/reactions/$EMOJI/@me" "{}" ;;
	'del')
		MSG=$(echo "$TEXT" | jq -r ".id"); EMOJI=$(echo "$TEXT" | jq -r ".emoji")
		dapi DELETE "/channels/$CHANNEL/messages/$MSG/reactions/$EMOJI/@me" "{}" ;;
	'del_mod')
		USER=$(echo "$TEXT"| jq -r ".author")
		MSG=$(echo "$TEXT" | jq -r ".id"); EMOJI=$(echo "$TEXT" | jq -r ".emoji")
		dapi DELETE "/channels/$CHANNEL/messages/$MSG/reactions/$EMOJI/$USER" "{}" ;;
	'del_all')
		MSG=$(echo "$TEXT" | jq -r ".id")
		dapi DELETE "/channels/$CHANNEL/messages/$MSG/reactions" "{}" ;;
	esac ;;
*)
	echo "Usage: reaction {COMMAND} {JSON}" >&2
	echo "Interacts with reaction endpoints"
	echo ""
	echo "Every command accepts a string of JSON, as stdout or arg"
       	echo "Avaliable commands with their respective JSON keys:"
	echo ""
	echo "get: {id} {channel} {emoji} [before] [after] [limit]"
	echo "    id: (snowflake) the id of the message"
	echo "    channel: (snowflake) the id of the channel"
	echo "    emoji: (string) the target emoji"
	echo "    before: (snowflake) get users before this message id"
	echo "    after: (snowflake) get users after this message id"
	echo "    limit: (integer)  max number of users to return (1-100)"
	echo ""
	echo "add: {id} {channel} {emoji}"
	echo "    id: (snowflake) the id of the message"
	echo "    channel: (snowflake) the id of the channel"
	echo "    emoji: (string) the target emoji"
	echo ""
	echo "del: {id} {channel} {emoji}"
	echo "    id: (snowflake) the id of the message"
	echo "    channel: (snowflake) the id of the channel"
	echo "    emoji: (string) the target emoji"
	echo ""
	echo "del_mod: {id} {channel} {emoji} {author}"
	echo "    id: (snowflake) the id of the message"
	echo "    channel: (snowflake) the id of the channel"
	echo "    emoji: (string) the target emoji"
	echo "    author: (snowflake) the reaction author"
	echo ""
	echo "del_all: {id} {channel}"
	echo "    id: (snowflake) the id of the message"
	echo "    channel: (snowflake) the id of the channel"
	exit 1 ;;
esac
