#!/bin/bash

if [ -z "$2" ]; then
        echo "Usage: ws-shard {SHARD} {NUM_SHARDS}" >&2
        echo "Creates a connection with the gateway"
        exit 1
fi


LOGF="$MASH_STATUS_DIR/ws_log"

PIPE="$MASH_STATUS_DIR/ws_pipe_$1"
rm -f $PIPE; mkfifo $PIPE
exec 3<> $PIPE

ACKF="$MASH_STATUS_DIR/ws_lastack_$1"
[ -f $ACKF ] || touch $ACKF
SEQF="$MASH_STATUS_DIR/ws_seqf_$1"
[ -f $SEQF ] || touch $SEQF
SESF="$MASH_STATUS_DIR/ws_sessionid_$1"
[ -f $SESF ] || touch $SESF

ws-funnel "$1" &
trap 'kill 0' EXIT

heartbeat(){
	LACK="0"
	WAIT=15
	INTERVAL=$(awk "BEGIN { print ($3 / 1000) - $WAIT }")
	while true; do
		SEQ=$(cat "$SEQF")
		SEQ=${SEQ:-0}
		echo "$SEQ" | ws-send 1 "$2"
		ACK=$(cat "$ACKF")

		sleep "$WAIT"
		if [ "$LACK" == "$ACK" ]; then
			pkill -9 "$1"
			$4 "$5"; exit
		fi

		sleep "$INTERVAL"
		LACK=$ACK
	done
}

BUFFER=''
while read -r PAYLOAD; do
	if echo "$PAYLOAD" | jq &> /dev/null; then
		BUFFER="$PAYLOAD"
	else
		BUFFER="$BUFFER$PAYLOAD"
		if ! echo "$BUFFER" | jq &> /dev/null; then
			continue
		fi
	fi

	PAYLOAD="$BUFFER"

	OP=$(echo "$PAYLOAD" | jq -r '.op')
	DATA=$(echo "$PAYLOAD" | jq -cM '.d')

	case $OP in
	0)
	echo "$PAYLOAD" | jq -r '.s' > $SEQF
	if [ "$(echo "$PAYLOAD" | jq -r '.t')" == 'READY' ]; then
		echo "$DATA" | jq -r '.session_id' > $SESF
	fi
	echo "$PAYLOAD" >> $LOGF
	echo "$PAYLOAD" ;;	
	7)
	$0 "$@"; exit ;;
	9)
	rm -f $SESF
	$0 "$@"; exit ;;
	10)
	INTERVAL=$(echo "$DATA" | jq -r '.heartbeat_interval')
	heartbeat "$$" "$1" "$INTERVAL" "$0" "$@" &

	[ -f "$SESF" ] && SES=$(cat $SESF)
	if [ -z "$SES" ]; then
		echo "{\"token\": \"$MASH_AUTH_TOKEN\", \"properties\": {\"\$os\": \"linux\",\"\$browser\": \"mash\",\"\$device\": \"mash\"}, \"shard\": [$1, $2]}" | ws-send 2 "$1" 
	else
		SEQ=$(cat $SEQF); SEQ=${SEQ:-0}
		echo "{\"token\": \"$MASH_AUTH_TOKEN\", \"session_id\": \"$SES\", \"seq\": $SEQ}" | ws-send 6 "$1"
	fi ;;
	11)
	echo "$(( $(date +%s%N)/1000000 ))" > $ACKF ;;
	esac	
done < <(websocat -tnE "wss://gateway.discord.gg/?v=6&encoding=json" < $PIPE)

