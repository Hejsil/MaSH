#!/bin/bash
[[ $MASH_AUTH_BOT == "1" ]] && BOT='Bot '
[ -z $MASH_STATUS_DIR ] && MASH_STATUS_DIR='.mash_tmp'

ROUTE=$(echo $2 | cut -d'/' -f-3 | tr '/' '_')
LIMITG="$MASH_STATUS_DIR/global.lock"
LIMITF="$MASH_STATUS_DIR/$ROUTE.lock"
HEADERS=$(mktemp)
MASH_HTTP_USERAGENT="DiscordBot (https://github.com/Naranbataar/MaSH/ 0.0)"

while [ -f "$LIMITG" ]; do sleep 0.5; done

exec 4>$LIMITF
flock 4

if [ $1 == '@FILES' ]; then
	[[ -n "$4" ]] && TEXT=$4 || read TEXT
	N=0; FILES=$(echo "$4" | jq '.[]' | while read f; do echo -e " -F 'file$N=@$f'"; N=$(( $N+1 )); done)
	RESULT=$(echo $TEXT | curl -v -X "POST" -D $HEADERS -A "$MASH_HTTP_USERAGENT" -H "Authorization: $BOT$MASH_AUTH_TOKEN" -F "payload_json=$PAYLOAD" $FILES "https://discordapp.com/api$2")
else
	[[ -n "$3" ]] && TEXT=$3 || read TEXT
	RESULT=$(echo $TEXT | curl -v -X $1 -D $HEADERS -A "$MASH_HTTP_USERAGENT" -H "Authorization: $BOT$MASH_AUTH_TOKEN" -H "Content-Type: application/json" "https://discordapp.com/api$2" -d @-)
fi

if [[ "$(cat "$HEADERS" | head -n 1)" == *'429'* ]]; then
	retry=$( echo "$(echo "$RESULT" | jq -r '.retry_after') / 1000" | bc -l)
	global=$( echo "$RESULT" | jq -r '.global' )
	if [ "$global" == "true" ]; then
	       touch "$LIMITG"; sleep "$retry"; rm -f "$LIMITG"
	else
	       sleep "$retry"
	fi
	echo "$($0 "$@")"
	exit
else
	echo "$RESULT"
fi

REMAINING=$(grep -i -m 1 "x-ratelimit-remaining" "$HEADERS" | grep -o '[0-9]' | tr -d '\n')
if [ -n "$REMAINING" ]; then
    if [ $(( $REMAINING + 0 )) -lt 1 ]; then
	RESET=$(grep -i -m 1 "x-ratelimit-reset" "$HEADERS" | grep -o '[0-9]' | tr -d '\n')
	sleep $(( ($RESET - $(date '+%s')) ))
    fi	
fi
