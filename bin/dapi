#!/bin/sh

TOKEN="$(cat "config/token")"
[ "$(cat "config/bot")" = 'true' ] && BOT='Bot '

ROUTE=$(printf '%s\n' "$2" | cut -d'/' -f-3 | tr '/' '_')
LIMITF="lock/$ROUTE"
LIMITG="lock/global"
HEADERS=$(mktemp)
USERAGENT="DiscordBot (https://github.com/Naranbataar/MaSH/ 2.0)"

exec 4>"$LIMITF"; flock -s 4
exec 5>"$LIMITG"; flock -s 5

read -r TEXT
if [ "$1" = '@FILES' ]; then
    N=0
    FILES="$(printf '%s\n' "$3" \
             | jq '.[]' \
             | while read -r f; do
                   printf "-F 'file%s=@%s' " "$N" "$f"
                   N=$(( N+1 ))
               done)"
    RESULT="$(curl -s -X "POST" -D "$HEADERS" \
              -A "$USERAGENT" \
              -H "Authorization: $BOT$TOKEN" \
              -F "payload_json=$TEXT" \
              $FILES "https://discordapp.com/api$2")"
else
    [ "$TEXT" != ' ' ] && D='-d @-'
    RESULT="$(printf '%s\n' "$TEXT" \
              | curl -s -X "$1" -D "$HEADERS" \
                -A "$USERAGENT" \
                -H "Authorization: $BOT$TOKEN" \
                -H "Content-Type: application/json" \
                "https://discordapp.com/api$2" $D)"
fi

HEADERS=$(cat "$HEADERS")
CODE="$(printf '%s\n' "$HEADERS" | head -n 1)"
if [ "${CODE#*429}" != "$CODE" ]; then
    RETRY=$(printf '%s\n' "$(printf '%s\n' "$RESULT" \
                             | jq -r '.retry_after') / 1000" \
                             | bc -l)
    GLOBAL=$(printf '%s\n' "$RESULT" | jq -r '.global')
    if [ "$GLOBAL" = "true" ]; then
        flock 5
        touch "$LIMITG"; sleep "$RETRY"; rm -f "$LIMITG"
        flock -u 5
    else
        flock 4; sleep "$RETRY"; flock -u 4
    fi
    $0 "$@"
    exit
else
    printf '%s\n' "$RESULT"
fi

REMAINING="$(printf '%s\n' "$HEADERS" | grep -i "x-ratelimit-remaining" \
             sed 's/[^0-9]*//g')"
if [ -n "$REMAINING" ]; then
    if [ "$REMAINING" -lt 1 ]; then
        flock 4
        RESET="$(printf '%s\n' "$HEADERS" | grep -i "x-ratelimit-reset" \
                 sed 's/[^0-9]*//g')"
        sleep "$(( (RESET - $(date '+%s')) ))"
        flock -u 4
    fi
fi
