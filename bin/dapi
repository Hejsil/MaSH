#!/bin/bash

if [ -z "$2" ]; then
        echo "Usage: dapi {HTTP_COMMAND} {ROUTE}" >&2
        echo "Connects to the REST Api routes"
	echo ""
	echo "Accepts JSON data on STDIN, and outputs the result"
	echo "Special commands starts with @ and are listed below"
	echo ""
	echo "@FILES:"
	echo "    Send files using a POST request"
	echo "    Accepts an array of filepaths"
        exit 1
fi

[[ $MASH_AUTH_BOT == "1" ]] && BOT='Bot '
[ -z "$MASH_STATUS_DIR" ] && MASH_STATUS_DIR='.mash_tmp'

ROUTE=$(echo "$2" | cut -d'/' -f-3 | tr '/' '_')
LIMITG="$MASH_STATUS_DIR/global.lock"
LIMITF="$MASH_STATUS_DIR/$ROUTE.lock"
HEADERS=$(mktemp)
MASH_HTTP_USERAGENT="DiscordBot (https://github.com/Naranbataar/MaSH/ 1.1)"

while [ -f "$LIMITG" ]; do sleep 0.5; done

exec 4>"$LIMITF"
flock 4

read -r TEXT
if [ "$1" == '@FILES' ]; then
	N=0; FILES=$(echo "$FILES" | jq '.[]' | while read -r f; do echo -e " -F 'file$N=@$f'"; N=$(( N+1 )); done)
	RESULT=$(curl -s -X "POST" -D "$HEADERS" -A "$MASH_HTTP_USERAGENT" -H "Authorization: $BOT$MASH_AUTH_TOKEN" -F "payload_json=$TEXT" "$FILES" "https://discordapp.com/api$2")
else
	[ "$TEXT" != ' ' ] && d='-d @-'
	RESULT=$(echo "$TEXT" | curl -s -X "$1" -D "$HEADERS" -A "$MASH_HTTP_USERAGENT" -H "Authorization: $BOT$MASH_AUTH_TOKEN" -H "Content-Type: application/json" "https://discordapp.com/api$2" $d)
fi

HEADERS=$(cat "$HEADERS")
if [[ "$(echo "$HEADERS" | head -n 1)" == *'429'* ]]; then
	retry=$(echo "$(echo "$RESULT" | jq -r '.retry_after') / 1000" | bc -l)
	global=$(echo "$RESULT" | jq -r '.global')
	if [ "$global" == "true" ]; then
	       touch "$LIMITG"; sleep "$retry"; rm -f "$LIMITG"
	else
	       sleep "$retry"
	fi
	$0 "$@"
	exit
else
	echo "$RESULT"
fi

mapfile -t LIMITS <<< $(echo "$HEADERS" | grep -i "x-ratelimit" | sed 's/[^0-9]*//g')
REMAINING=${LIMITS[1]}; RESET=${LIMITS[2]}
if [ -n "$REMAINING" ]; then
    if [ $(( REMAINING + 0 )) -lt 1 ]; then
	sleep $(( (RESET - $(date '+%s')) ))
    fi	
fi
