#!/bin/bash
[ -z "$MASH_STATUS_DIR" ] && MASH_STATUS_DIR='.mash_tmp'
[ -d $MASH_STATUS_DIR ] || mkdir "$MASH_STATUS_DIR"

if [ -z "$1" ]; then
	echo "Usage: ewait {CONDITION} [TIMEOUT]" >&2
       	echo "Watches the log until it finds a event that meet the jq condition, and outputs it"	
      	exit 1
fi

while IFS= read -r EVENT || [[ -n "$EVENT" ]]; do
	echo "$EVENT"; exit
done < <(timeout "${2:-0}" tail -n0 -qf "$MASH_STATUS_DIR/ws_log_"* | jq -cM --stream --unbuffered "fromstream(0|truncate_stream(inputs)) | select($1)")

