#!/bin/bash

case $1 in
'get'|'new'|'edit'|'del'|'sync')
	[[ ! -z "$2" ]] && TEXT=$2 || read TEXT
	GUILD=$(echo "$TEXT" | jq -r ".guild");
	TEXT=$(echo "$TEXT" | jq "del(.guild)")
	case $1 in
	'get')
		dapi GET "/guilds/$GUILD/integrations" "{}" ;;
	'new')
		PAYLOAD=$(filter-args json "$TEXT" 'id,type')
		dapi POST "/guilds/$GUILD/integrations" "$PAYLOAD" ;;
	'edit')
		INTG=$(echo "$TEXT"| jq -r ".id")
		PAYLOAD=$(filter-args json "$TEXT" 'expire_behavior,expire_grace_period,enable_emoticons')
		dapi PATCH "/guilds/$GUILD/integrations/$INTG" "$PAYLOAD" ;;
	'del')
		INTG=$(echo "$TEXT"| jq -r ".id")
		dapi DELETE "/guilds/$GUILD/integrations/$INTG" "{}" ;;
	'sync')
		INTG=$(echo "$TEXT"| jq -r ".id")
		dapi POST "/guilds/$GUILD/integrations/$INTG/sync" "{}" ;;
	esac ;;
*)
	echo "Usage: integration {COMMAND} {JSON}" >&2
	echo "Interacts with guild integration endpoints"
	echo ""
	echo "Every command accepts a string of JSON, as stdout or arg"
       	echo "Avaliable commands with their respective JSON keys:"
	echo ""
	echo "get: {guild} "
	echo "    guild: (snowflake) the id of the guild"
	echo ""
	echo "new: {id} {guild} {type}"
	echo "    id: (snowflake) the id of the integration"
	echo "    guild: (snowflake) the id of the guild"
	echo "    type: (string) the type of the integration"
	echo ""
	echo "edit: {id} {guild} [expire_behavior] [expire_grace_period] "
	echo "[enable_emoticons]"
	echo "    id: (snowflake) the id of the integration"
	echo "    guild: (snowflake) the id of the guild"
	echo "    expire_behavior: (integer) the behavior when an "
	echo "        integration subscription lapses"
	echo "    expire_grace_period: (integer) period in seconds "
	echo "        where the integration will ignore lapsed "
	echo "        subscriptions"
	echo "    enable_emoticons (boolean) whether emoticons should be "
	echo "        synced for this integration"
	echo ""
	echo "del: {id} {guild}"
	echo "    id: (snowflake) the id of the integration"
	echo "    guild: (snowflake) the id of the guild"
	echo ""
	echo "sync: {id} {guild}"
	echo "    id: (snowflake) the id of the integration"
	echo "    guild: (snowflake) the id of the guild"
	exit 1 ;;
esac
