#!/bin/bash

if [ -z "$1" ]; then
        echo "Usage: ws-funnel {SHARD}" >&2
        echo "Limits the websocket connection on 120 requests per 60 seconds"
        exit 1
fi

N=120; T=60; S=0

PIPE="$MASH_STATUS_DIR/ws_pipe_$1"

FUNNEL="$MASH_STATUS_DIR/ws_funnel_$1"
rm -f "$FUNNEL"; mkfifo "$FUNNEL"

TN=$(echo "$T/$N" | bc -l)
rate-limit(){
	PAYLOAD="$1"

	now=$(date '+%s')
	SN=$(echo "$([ "$(echo "$S==0" | bc -l)" == "1" ] && echo "$now" || echo "$SN") + $TN" | bc -l)
	if [ "$(echo "$SN < $now" | bc -l)" == "1" ]; then
		S=$(echo "$now + $TN" | bc -l)
	elif [ "$(echo "$SN > ($now+$T)" | bc -l)" == "1" ]; then
		sleep "$(echo "$SN - ($now+$T)" | bc -l)"
	else
		S=$SN
	fi

	[ "$PAYLOAD" != 'dummy' ] && echo "$PAYLOAD" > "$PIPE"
}

. `which env_parallel.bash`
tail -f > "$FUNNEL" &
(for x in $(seq $(parallel --number-of-threads)); do echo "dummy"; done; cat "$FUNNEL") | env_parallel --lb -q rate-limit 
