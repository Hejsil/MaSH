#!/bin/bash
N=120; T=60; S=0

PIPE="$MASH_STATUS_DIR/ws_pipe_$1"
exec 3<> $PIPE

FUNNEL="$MASH_STATUS_DIR/ws_funnel_$1"
rm -f $FUNNEL; mkfifo $FUNNEL
exec 4<> $FUNNEL

TN=$(echo "$T/$N" | bc -l)
while read -r PAYLOAD; do
	now=$(date '+%s')
	SN=$(echo "$([ "$(echo "$S==0" | bc -l)" == "1" ] && echo "$now" || echo "$SN") + $TN" | bc -l)
	if [ "$(echo "$SN < $now" | bc -l)" == "1" ]; then
		S=$(echo "$now + $TN" | bc -l)
	elif [ "$(echo "$SN > ($now+$T)" | bc -l)" == "1" ]; then
		sleep "$(echo "$SN - ($now+$T)" | bc -l)"
	else
		S=$SN
	fi

	echo "$PAYLOAD" | jq -cM >&3
done < $FUNNEL	
