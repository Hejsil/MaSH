#!/bin/bash
N=120; T=60; S=0
[ -z $MASH_STATUS_DIR ] && MASH_STATUS_DIR='.mash_tmp'

PIPE="$MASH_STATUS_DIR/ws_pipe"
exec 3<> $PIPE

FUNNEL="$MASH_STATUS_DIR/ws_funnel"
[ -p $FUNNEL ] || mkfifo $FUNNEL
exec 4<> $FUNNEL
trap "rm $FUNNEL" EXIT

TN=$(echo "$T/$N" | bc -l)
while read PAYLOAD; do
	now=$(date '+%s')
	SN=$(echo "$([ "$(echo "$S==0" | bc -l)" == "1" ] && echo "$now" || echo "$SN") + $TN" | bc -l)
	if [ "$(echo "$SN < $now" | bc -l)" == "1" ]; then
		S=$(echo "$now + $TN" | bc -l)
	elif [ "$(echo "$SN > ($now+$T)" | bc -l)" == "1" ]; then
		sleep "$(echo "$SN - ($now+$T)" | bc -l)"
	else
		S=$SN
	fi

	echo "$PAYLOAD" | jq -cM >&3
done < $FUNNEL	
