#!/bin/bash
MASH_WS_PID="$$"
export MASH_WS_PID

[ -z $MASH_STATUS_DIR ] && MASH_STATUS_DIR='.mash_tmp'
[ -d $MASH_STATUS_DIR ] || mkdir "$MASH_STATUS_DIR"

PIPE="$MASH_STATUS_DIR/ws_pipe"
[ -p $PIPE ] || mkfifo $PIPE
exec 3<> $PIPE
trap "rm $PIPE" EXIT

ACKF="$MASH_STATUS_DIR/ws_lastack"
[ -f $ACKF ] || touch $ACKF
SEQF="$MASH_STATUS_DIR/ws_seqf"
[ -f $SEQF ] || touch $SEQF
SESF="$MASH_STATUS_DIR/ws_sessionid"
[ -f $SESF ] || touch $SESF

ws-funnel &

heartbeat(){
	LACK="0"
	WAIT=15
	INTERVAL=$(awk -v m=$m "BEGIN { print ($1 / 1000) - $WAIT }")
	while true; do
		SEQ=$(cat "$SEQF")
		echo "$SEQ" | ws-send 1
		ACK=$(cat "$ACKF")

		sleep "$WAIT"
		if [ "$LACK" == "$ACK" ]; then
			pkill -15 $MASH_WS_PID
			exit 143
		fi

		sleep "$INTERVAL"
		LACK=$ACK
	done
}

while read PAYLOAD; do
	OP=$(echo "$PAYLOAD" | jq -r '.op')
	DATA=$(echo "$PAYLOAD" | jq -cM '.d')

	case $OP in
	0)
	echo "$(echo "$PAYLOAD" | jq -r '.s')" > $SEQF
	echo "$PAYLOAD" ;;	
	1)
	echo "$(echo "$DATA" | jq -r '.session_id')" > $SESF ;;
	7)
	exit 143 ;;
	9)
	rm $SESF
	exit 143 ;;
	10)
	INTERVAL=$(echo "$DATA" | jq -r '.heartbeat_interval')
	heartbeat "$INTERVAL" &

	if [ -f "$SESF" ]; then
		echo "{\"token\": \"$MASH_AUTH_TOKEN\", \"properties\": {\"\$os\": \"linux\",\"\$browser\": \"mash\",\"\$device\": \"mash\"}}" | ws-send 2
	else
		SEQ=$(cat $SEQF); SES=$(cat $SESF)
		echo "{\"token\": \"$MASH_AUTH_TOKEN\", \"session_id\": \"$SES\", \"seq\": $SEQ}" | ws-send 6
	fi ;;
	11)
	echo "$(( $(date +%s%N)/1000000 ))" > $ACKF ;;
	esac	
done < <(websocat -tnE "wss://gateway.discord.gg/?v=6&encoding=json" < $PIPE)
exit 143
